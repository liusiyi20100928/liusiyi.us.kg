<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>后台管理 - 九年级回忆手册</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap');
    body { font-family: 'Quicksand', sans-serif; background-color: #ffe4e1; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #d6336c; margin-bottom: 20px; }
    .section { background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 30px; }
    .section h2 { margin-top: 0; color: #c0392b; }
    label, textarea, input, button { font-family: 'Quicksand', sans-serif; }
    textarea { width: 100%; height: 120px; border: 1px solid #ccc; border-radius: 8px; padding: 10px; resize: vertical; margin-bottom: 10px; }
    input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; }
    button { padding: 10px 20px; background-color: #ff99aa; border: none; border-radius: 8px; color: white; cursor: pointer; margin-right: 10px; }
    button:hover { background-color: #ff8099; }
    .album-list { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 10px; }
    .album-item { position: relative; width: 120px; text-align: center; }
    .album-item img { width: 100%; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .album-item span { display: block; margin-top: 6px; font-size: 14px; color: #333; }
    .delete-btn { position: absolute; top: 4px; right: 4px; background: rgba(255,0,0,0.8); border: none; border-radius: 50%; width: 20px; height: 20px; color: white; font-size: 14px; line-height: 18px; cursor: pointer; }
    .delete-btn:hover { background: rgba(255,0,0,1); }
    .message { margin-top: 10px; color: green; }
    /* 查询结果卡片样式 */
    .profile-card {
      border: 1px solid #ccc; padding: 15px; margin: 15px 0; text-align: center; border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .profile-photo {
      width: 100px; height: 100px; object-fit: cover; border-radius: 50%; display: block; margin: 0 auto 10px;
    }
    .info p { margin: 5px 0; color: #333; }
  </style>
</head>
<body>
  <h1>后台管理 · 九年级回忆手册</h1>

  <!-- 1. 仓库与访问令牌设置 -->
  <div class="section">
    <h2>仓库与访问令牌设置</h2>
    <label>GitHub 用户名 / 组织名：</label>
    <input type="text" id="gh-username" placeholder="你的 GitHub 用户名（区分大小写）" />
    <label>仓库名（用户/仓库）：</label>
    <input type="text" id="gh-repo" placeholder="例：myusername/repo" />
    <label>个人访问令牌（PAT, 含 repo 权限）：</label>
    <input type="text" id="gh-token" placeholder="在此粘贴你的 GitHub PAT" />
    <button id="btn-init">初始化</button>
    <div id="init-msg" class="message"></div>
  </div>

  <!-- 2. 回忆相册管理 -->
  <div class="section" id="album-section" style="display:none;">
    <h2>回忆相册管理</h2>
    <label>上传新图片（以 huiyi 开头）：</label>
    <input type="file" id="album-upload" accept="image/*" />
    <button id="btn-upload-photo">上传</button>
    <div id="upload-msg" class="message"></div>
    <h3>当前相册列表：</h3>
    <div class="album-list" id="album-list"></div>
  </div>

  <!-- 3. 信息查询管理（交互式 UI） -->
  <div class="section" id="info-section" style="display:none;">
    <h2>信息查询管理</h2>
    <label>姓名查询（完全匹配）：</label>
    <input type="text" id="search-input" placeholder="请输入姓名">
    <button id="btn-search">查询</button>
    <div id="search-result" style="margin-top:15px;"></div>
  </div>

  <!-- 4. 寻求帮助管理 -->
  <div class="section" id="help-section" style="display:none;">
    <h2>寻求帮助管理</h2>
    <label>编辑 data/help.txt（填写 QQ 群链接）：</label>
    <input type="text" id="help-input" placeholder="https://jq.qq.com/?_wv=1027&k=示例" />
    <button id="btn-save-help">保存链接</button>
    <div id="save-help-msg" class="message"></div>
  </div>

  <!-- 引入 CryptoJS -->
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script>
    // ==== 本地加密存储脚本 ====
    const STORAGE_KEY = 'student_data_enc';
    function loadData() {
      const enc = localStorage.getItem(STORAGE_KEY);
      if (!enc) return [];
      const pwd = 'fixed_global_password'; // 默认全局密码，可自行修改
      const bytes = CryptoJS.AES.decrypt(enc, pwd);
      const json  = bytes.toString(CryptoJS.enc.Utf8);
      return JSON.parse(json || '[]');
    }
    function saveData(arr) {
      const pwd = 'fixed_global_password';
      const json = JSON.stringify(arr);
      const enc  = CryptoJS.AES.encrypt(json, pwd).toString();
      localStorage.setItem(STORAGE_KEY, enc);
    }
    // ===========================

    let repoOwner, repoName, authToken, imagesSHA, helpSHA;

    // 初始化：加载相册 & 帮助文本
    document.getElementById('btn-init').addEventListener('click', async () => {
      repoOwner = document.getElementById('gh-username').value.trim();
      const repoFull = document.getElementById('gh-repo').value.trim();
      authToken = document.getElementById('gh-token').value.trim();
      if (!repoOwner || !repoFull || !authToken) {
        document.getElementById('init-msg').textContent = '请填写完整信息。';
        return;
      }
      const parts = repoFull.split('/');
      if (parts.length !== 2) {
        document.getElementById('init-msg').textContent = '仓库名格式应为 "用户/仓库"。';
        return;
      }
      repoName = parts[1];
      document.getElementById('init-msg').textContent = '初始化中...';
      try {
        await loadImagesJSON();
        await loadHelpTXT();
        document.getElementById('album-section').style.display = 'block';
        document.getElementById('info-section').style.display = 'block';
        document.getElementById('help-section').style.display = 'block';
        document.getElementById('init-msg').textContent = '初始化完成。';
      } catch (err) {
        console.error(err);
        document.getElementById('init-msg').textContent = '初始化失败，请检查控制台与输入内容。';
      }
    });

    // ---- GitHub 文件操作函数（保持不变） ----
    async function getFile(path) {
      const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
      const resp = await fetch(url, { headers: { Authorization: `token ${authToken}` } });
      if (!resp.ok) throw new Error(`获取 ${path} 失败：${resp.status}`);
      return await resp.json();
    }

    async function putFile(path, contentBase64, sha, message) {
      const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
      const body = { message, content: contentBase64, sha };
      const resp = await fetch(url, {
        method: 'PUT',
        headers: { Authorization: `token ${authToken}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!resp.ok) throw new Error(`更新 ${path} 失败：${resp.status}`);
      return await resp.json();
    }

    // 加载 & 渲染 images.json
    async function loadImagesJSON() {
      const data = await getFile('data/images.json');
      const arr = JSON.parse(atob(data.content));
      imagesSHA = data.sha;
      const list = document.getElementById('album-list');
      list.innerHTML = '';
      arr.forEach(src => {
        const div = document.createElement('div');
        div.className = 'album-item';
        div.innerHTML = `<img src="https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${src}" />
                         <button class="delete-btn">×</button>`;
        div.querySelector('.delete-btn').onclick = async () => {
          const idx = arr.indexOf(src);
          arr.splice(idx, 1);
          await putFile('data/images.json', btoa(JSON.stringify(arr)), imagesSHA, '删除图片');
          imagesSHA = (await getFile('data/images.json')).sha;
          loadImagesJSON();
        };
        list.appendChild(div);
      });
    }

    // 上传新照片
    document.getElementById('btn-upload-photo').addEventListener('click', () => {
      const file = document.getElementById('album-upload').files[0];
      if (!file) return alert('请选择图片');
      const reader = new FileReader();
      reader.onload = async () => {
        const base64Data = reader.result.split(',')[1];
        const newPath = `image/${file.name}`;
        await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${newPath}`, {
          method: 'PUT',
          headers: { Authorization: `token ${authToken}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: `上传 ${file.name}`, content: base64Data })
        });
        document.getElementById('upload-msg').textContent = '上传成功';
        await loadImagesJSON();
      };
      reader.readAsDataURL(file);
    });

    // 加载 & 渲染 help.txt
    async function loadHelpTXT() {
      const data = await getFile('data/help.txt');
      const content = atob(data.content).trim();
      helpSHA = data.sha;
      document.getElementById('help-input').value = content;
    }
    document.getElementById('btn-save-help').addEventListener('click', async () => {
      const newLink = document.getElementById('help-input').value.trim();
      const updatedContent = btoa(newLink);
      await putFile('data/help.txt', updatedContent, helpSHA, '更新 help.txt');
      document.getElementById('save-help-msg').textContent = '保存成功';
    });

    // ---- 新增：信息查询管理交互 ----
    document.getElementById('btn-search').addEventListener('click', () => {
      const key = document.getElementById('search-input').value.trim();
      const resultEl = document.getElementById('search-result');
      resultEl.innerHTML = '';
      if (!key) {
        resultEl.innerHTML = '<p style="color:#c0392b">请输入姓名进行查询。</p>';
        return;
      }
      const arr = loadData();
      const matched = arr.filter(x => x.name === key);
      if (matched.length === 0) {
        resultEl.innerHTML = '<p style="color:#c0392b">未找到匹配的记录。</p>';
        return;
      }
      matched.forEach(x => {
        const card = document.createElement('div');
        card.className = 'profile-card';
        card.innerHTML = `
          <img src="${x.photo}" class="profile-photo">
          <div class="info">
            <p><strong>姓名：</strong>${x.name}</p>
            <p><strong>班级：</strong>${x.cls}</p>
            <p><strong>手机号：</strong>${x.phone}</p>
            <p><strong>微信：</strong>${x.wx}</p>
            <p><strong>QQ：</strong>${x.qq}</p>
          </div>`;
        resultEl.appendChild(card);
      });
    });
    // =================================

  </script>
</body>
</html>
