<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>后台管理 - 九年级回忆手册</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap');
    body { font-family: 'Quicksand', sans-serif; background-color: #ffe4e1; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #d6336c; margin-bottom: 20px; }
    .section { background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 30px; }
    .section h2 { margin-top: 0; color: #c0392b; }
    label, input, button { font-family: 'Quicksand', sans-serif; }
    input[type="text"], input[type="file"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; }
    button { padding: 8px 16px; background-color: #ff99aa; border: none; border-radius: 8px; color: white; cursor: pointer; margin-right: 6px; }
    button:hover { background-color: #ff8099; }
    .message { margin-top: 10px; color: green; }
    /* 相册列表 */
    .album-list { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 10px; }
    .album-item { position: relative; width: 120px; text-align: center; }
    .album-item img { width: 100%; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .delete-btn { position: absolute; top: 4px; right: 4px; background: rgba(255,0,0,0.8); border: none; border-radius: 50%; width: 20px; height: 20px; color: white; font-size: 14px; line-height: 18px; cursor: pointer; }
    .delete-btn:hover { background: rgba(255,0,0,1); }
    /* 信息卡片样式 */
    .info-list { display: flex; flex-direction: column; gap: 15px; margin-top: 15px; }
    .info-card {
      position: relative;
      border: 1px solid #ccc; padding: 15px; border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); background: #fafafa;
    }
    .info-card img {
      width: 80px; height: 80px; object-fit: cover; border-radius: 50%;
      float: right; margin-left: 15px;
    }
    .info-card p { margin: 4px 0; color: #333; }
    .card-buttons { margin-top: 10px; }
    .card-buttons button { padding: 6px 12px; font-size: 14px; }
    /* 编辑弹窗样式 */
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); align-items: center; justify-content: center;
    }
    .modal-content {
      background: #fff; padding: 20px; border-radius: 8px; width: 320px; position: relative;
    }
    .modal-content h3 { margin-top: 0; }
    .modal-content input { width: 100%; margin-bottom: 10px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    .modal-content .close-btn {
      position: absolute; top: 10px; right: 10px; background: #eee; border: none;
      width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
    }
    .modal-content .close-btn:hover { background: #ccc; }
  </style>
</head>
<body>
  <h1>后台管理 · 九年级回忆手册</h1>

  <!-- 1. 仓库与访问令牌设置 -->
  <div class="section">
    <h2>仓库与访问令牌设置</h2>
    <label>GitHub 用户名 / 组织名：</label>
    <input type="text" id="gh-username" placeholder="你的 GitHub 用户名（区分大小写）" />
    <label>仓库名（用户/仓库）：</label>
    <input type="text" id="gh-repo" placeholder="例：myusername/repo" />
    <label>个人访问令牌（PAT, 含 repo 权限）：</label>
    <input type="text" id="gh-token" placeholder="在此粘贴你的 GitHub PAT" />
    <button id="btn-init">初始化</button>
    <div id="init-msg" class="message"></div>
  </div>

  <!-- 2. 回忆相册管理 -->
  <div class="section" id="album-section" style="display:none;">
    <h2>回忆相册管理</h2>
    <label>上传新图片（以 huiyi 开头）：</label>
    <input type="file" id="album-upload" accept="image/*" />
    <button id="btn-upload-photo">上传</button>
    <div id="upload-msg" class="message"></div>
    <h3>当前相册列表：</h3>
    <div class="album-list" id="album-list"></div>
  </div>

  <!-- 3. 信息管理（UI 交互编辑 data/info.txt） -->
  <div class="section" id="info-section" style="display:none;">
    <h2>信息管理</h2>
    <button id="btn-add-info">新增信息</button>
    <div id="info-list" class="info-list"></div>
  </div>

  <!-- 编辑/新增 弹窗 -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="modal-close">×</button>
      <h3 id="modal-title">编辑信息</h3>
      <input type="text" id="field-name" placeholder="姓名" />
      <input type="text" id="field-class" placeholder="班级" />
      <input type="text" id="field-phone" placeholder="电话" />
      <input type="text" id="field-qq" placeholder="QQ" />
      <input type="text" id="field-weixin" placeholder="微信" />
      <label>照片：</label>
      <input type="file" id="field-photo" accept="image/*" />
      <button id="modal-save">保存</button>
    </div>
  </div>

  <!-- 4. 寻求帮助管理 -->
  <div class="section" id="help-section" style="display:none;">
    <h2>寻求帮助管理</h2>
    <label>编辑 data/help.txt（填写 QQ 群链接）：</label>
    <input type="text" id="help-input" placeholder="https://jq.qq.com/?_wv=1027&k=示例" />
    <button id="btn-save-help">保存链接</button>
    <div id="save-help-msg" class="message"></div>
  </div>

  <!-- 引入 CryptoJS -->
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script>
    // —— 本地加密存储脚本 —— 
    const STORAGE_KEY = 'student_data_enc';
    function loadData() {
      const enc = localStorage.getItem(STORAGE_KEY);
      if (!enc) return [];
      const pwd = 'fixed_global_password';
      const bytes = CryptoJS.AES.decrypt(enc, pwd);
      const json  = bytes.toString(CryptoJS.enc.Utf8);
      return JSON.parse(json || '[]');
    }
    function saveData(arr) {
      const pwd = 'fixed_global_password';
      const enc = CryptoJS.AES.encrypt(JSON.stringify(arr), pwd).toString();
      localStorage.setItem(STORAGE_KEY, enc);
    }
    // ——————————————

    let repoOwner, repoName, authToken, imagesSHA, helpSHA, infoSHA, modalState;

    // 初始化：加载相册、帮助、信息列表
    document.getElementById('btn-init').addEventListener('click', async () => {
      repoOwner = document.getElementById('gh-username').value.trim();
      const repoFull = document.getElementById('gh-repo').value.trim();
      authToken = document.getElementById('gh-token').value.trim();
      if (!repoOwner || !repoFull || !authToken) {
        document.getElementById('init-msg').textContent = '请填写完整信息。';
        return;
      }
      const parts = repoFull.split('/');
      if (parts.length !== 2) {
        document.getElementById('init-msg').textContent = '仓库名格式应为 "用户/仓库"。';
        return;
      }
      repoName = parts[1];
      document.getElementById('init-msg').textContent = '初始化中...';
      try {
        await Promise.all([loadImagesJSON(), loadHelpTXT(), loadInfo()]);
        document.getElementById('album-section').style.display = 'block';
        document.getElementById('info-section').style.display = 'block';
        document.getElementById('help-section').style.display = 'block';
        document.getElementById('init-msg').textContent = '初始化完成。';
      } catch (err) {
        console.error(err);
        document.getElementById('init-msg').textContent = '初始化失败，请检查控制台与输入内容。';
      }
    });

    // — GitHub 通用文件操作 — 
    async function getFile(path) {
      const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
      const resp = await fetch(url, { headers: { Authorization: `token ${authToken}` } });
      if (!resp.ok) throw new Error(`获取 ${path} 失败：${resp.status}`);
      return await resp.json();
    }
    async function putFile(path, contentBase64, sha, message) {
      const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
      const body = { message, content: contentBase64, sha };
      const resp = await fetch(url, {
        method: 'PUT',
        headers: { Authorization: `token ${authToken}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!resp.ok) throw new Error(`更新 ${path} 失败：${resp.status}`);
      return await resp.json();
    }
    // ——————————————————————

    // —— 回忆相册管理 —— 
    async function loadImagesJSON() {
      const data = await getFile('data/images.json');
      const arr = JSON.parse(atob(data.content));
      imagesSHA = data.sha;
      const list = document.getElementById('album-list');
      list.innerHTML = '';
      arr.forEach(src => {
        const div = document.createElement('div');
        div.className = 'album-item';
        div.innerHTML = `
          <img src="https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${src}" />
          <button class="delete-btn">&times;</button>`;
        div.querySelector('.delete-btn').onclick = async () => {
          arr.splice(arr.indexOf(src), 1);
          const newContent = btoa(JSON.stringify(arr));
          const res = await putFile('data/images.json', newContent, imagesSHA, '删除图片');
          imagesSHA = res.content.sha;
          loadImagesJSON();
        };
        list.appendChild(div);
      });
    }
    document.getElementById('btn-upload-photo').addEventListener('click', () => {
      const file = document.getElementById('album-upload').files[0];
      if (!file) return alert('请选择图片');
      const reader = new FileReader();
      reader.onload = async () => {
        const base64Data = reader.result.split(',')[1];
        const newPath = `image/${file.name}`;
        await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${newPath}`, {
          method: 'PUT',
          headers: { Authorization: `token ${authToken}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: `上传 ${file.name}`, content: base64Data })
        });
        document.getElementById('upload-msg').textContent = '上传成功';
        loadImagesJSON();
      };
      reader.readAsDataURL(file);
    });
    // ——————————————————

    // —— 帮助管理 —— 
    async function loadHelpTXT() {
      const data = await getFile('data/help.txt');
      helpSHA = data.sha;
      document.getElementById('help-input').value = atob(data.content).trim();
    }
    document.getElementById('btn-save-help').addEventListener('click', async () => {
      const newLink = document.getElementById('help-input').value.trim();
      const contentBase64 = btoa(newLink);
      const res = await putFile('data/help.txt', contentBase64, helpSHA, '更新 help.txt');
      helpSHA = res.content.sha;
      document.getElementById('save-help-msg').textContent = '保存成功';
    });
    // ——————————————————

    // —— 信息管理 —— 
    async function loadInfo() {
      const data = await getFile('data/info.txt');
      infoSHA = data.sha;
      const arr = JSON.parse(atob(data.content) || '[]');
      renderInfoList(arr);
    }

    function renderInfoList(arr) {
      const container = document.getElementById('info-list');
      container.innerHTML = '';
      arr.forEach((x, idx) => {
        const card = document.createElement('div');
        card.className = 'info-card';
        card.innerHTML = `
          <img src="${x.photo}" alt="头像" />
          <p><strong>姓名：</strong>${x.name}</p>
          <p><strong>班级：</strong>${x.cls}</p>
          <p><strong>电话：</strong>${x.phone}</p>
          <p><strong>QQ：</strong>${x.qq}</p>
          <p><strong>微信：</strong>${x.wx}</p>
          <div class="card-buttons">
            <button data-idx="${idx}" class="btn-edit">编辑</button>
            <button data-idx="${idx}" class="btn-delete">删除</button>
          </div>`;
        container.appendChild(card);
      });
      // 绑定事件
      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.onclick = () => openModal('edit', parseInt(btn.dataset.idx), arr);
      });
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.onclick = () => deleteInfo(parseInt(btn.dataset.idx), arr);
      });
    }

    function openModal(type, idx, arr) {
      document.getElementById('modal-title').innerText = type === 'add' ? '新增信息' : '编辑信息';
      if (type === 'edit') {
        const x = arr[idx];
        document.getElementById('field-name').value   = x.name;
        document.getElementById('field-class').value  = x.cls;
        document.getElementById('field-phone').value  = x.phone;
        document.getElementById('field-qq').value     = x.qq;
        document.getElementById('field-weixin').value = x.wx;
      } else {
        ['name','class','phone','qq','weixin'].forEach(f => {
          document.getElementById(`field-${f}`).value = '';
        });
      }
      document.getElementById('field-photo').value = '';
      modalState = { type, idx, arr };
      document.getElementById('modal').style.display = 'flex';
    }

    document.getElementById('modal-close').onclick = () => {
      document.getElementById('modal').style.display = 'none';
    };

    document.getElementById('btn-add-info').onclick = () => {
      openModal('add', null, loadData());
    };

    document.getElementById('modal-save').onclick = () => {
      const name  = document.getElementById('field-name').value.trim();
      const cls   = document.getElementById('field-class').value.trim();
      const phone = document.getElementById('field-phone').value.trim();
      const qq    = document.getElementById('field-qq').value.trim();
      const wx    = document.getElementById('field-weixin').value.trim();
      const file  = document.getElementById('field-photo').files[0];
      if (!name || !cls || !phone || !qq || !wx) {
        return alert('请填写所有字段');
      }
      const process = (readerResult) => {
        const arr = modalState.arr;
        const obj = {
          name, cls, phone, qq, wx,
          photo: readerResult || arr[modalState.idx]?.photo
        };
        if (modalState.type === 'add') arr.push(obj);
        else arr[modalState.idx] = obj;
        // 写回 GitHub
        const contentBase64 = btoa(JSON.stringify(arr));
        putFile('data/info.txt', contentBase64, infoSHA,
                modalState.type === 'add' ? '新增信息' : '编辑信息')
          .then(res => {
            infoSHA = res.content.sha;
            renderInfoList(arr);
            document.getElementById('modal').style.display = 'none';
          })
          .catch(err => console.error(err));
      };
      if (file) {
        const reader = new FileReader();
        reader.onload = () => process(reader.result);
        reader.readAsDataURL(file);
      } else {
        process(null);
      }
    };

    function deleteInfo(idx, arr) {
      if (!confirm('确定删除此条信息？')) return;
      arr.splice(idx, 1);
      const contentBase64 = btoa(JSON.stringify(arr));
      putFile('data/info.txt', contentBase64, infoSHA, '删除信息')
        .then(res => {
          infoSHA = res.content.sha;
          renderInfoList(arr);
        })
        .catch(err => console.error(err));
    }
    // ——————————————————————
  </script>
</body>
</html>
