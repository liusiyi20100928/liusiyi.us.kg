<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>后台管理 - 九年级回忆手册</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap');
    body { font-family: 'Quicksand', sans-serif; background-color: #ffe4e1; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #d6336c; margin-bottom: 20px; }
    .section { background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 30px; }
    .section h2 { margin-top: 0; color: #c0392b; }
    label, textarea, input, button { font-family: 'Quicksand', sans-serif; }
    textarea { width: 100%; height: 120px; border: 1px solid #ccc; border-radius: 8px; padding: 10px; resize: vertical; margin-bottom: 10px; }
    input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; }
    button { padding: 10px 20px; background-color: #ff99aa; border: none; border-radius: 8px; color: white; cursor: pointer; margin-right: 10px; }
    button:hover { background-color: #ff8099; }
    .album-list { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 10px; }
    .album-item { position: relative; width: 120px; text-align: center; }
    .album-item img { width: 100%; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .album-item span { display: block; margin-top: 6px; font-size: 14px; color: #333; }
    .delete-btn { position: absolute; top: 4px; right: 4px; background: rgba(255,0,0,0.8); border: none; border-radius: 50%; width: 20px; height: 20px; color: white; font-size: 14px; line-height: 18px; cursor: pointer; }
    .delete-btn:hover { background: rgba(255,0,0,1); }
    .message { margin-top: 10px; color: green; }
  </style>
</head>
<body>
  <h1>后台管理 · 九年级回忆手册</h1>
  <div class="section">
    <h2>仓库与访问令牌设置</h2>
    <label>GitHub 用户名 / 组织名：</label>
    <input type="text" id="gh-username" placeholder="你的 GitHub 用户名（区分大小写）" />
    <label>仓库名（用户名/仓库名）：</label>
    <input type="text" id="gh-repo" placeholder="例：myusername/repo" />
    <label>个人访问令牌（PAT, 含 repo 权限）：</label>
    <input type="text" id="gh-token" placeholder="在此粘贴你的 GitHub PAT" />
    <button id="btn-init">初始化</button>
    <div id="init-msg" class="message"></div>
  </div>
  <div class="section" id="album-section" style="display:none;">
    <h2>回忆相册管理</h2>
    <label>上传新图片（以 huiyi 开头）：</label>
    <input type="file" id="album-upload" accept="image/*" />
    <button id="btn-upload-photo">上传</button>
    <div id="upload-msg" class="message"></div>
    <h3>当前相册列表：</h3>
    <div class="album-list" id="album-list"></div>
  </div>
  <div class="section" id="info-section" style="display:none;">
    <h2>信息查询管理</h2>
    <label>编辑 data/info.txt 内容：</label>
    <textarea id="info-textarea"></textarea>
    <button id="btn-save-info">保存信息</button>
    <div id="save-info-msg" class="message"></div>
  </div>
  <div class="section" id="help-section" style="display:none;">
    <h2>寻求帮助管理</h2>
    <label>编辑 data/help.txt（填写 QQ 群链接）：</label>
    <input type="text" id="help-input" placeholder="https://jq.qq.com/?_wv=1027&k=示例" />
    <button id="btn-save-help">保存链接</button>
    <div id="save-help-msg" class="message"></div>
  </div>
  <script>
    let repoOwner, repoName, authToken;
    document.getElementById('btn-init').addEventListener('click', async () => {
      repoOwner = document.getElementById('gh-username').value.trim();
      const repoFull = document.getElementById('gh-repo').value.trim();
      authToken = document.getElementById('gh-token').value.trim();
      if (!repoOwner || !repoFull || !authToken) {
        document.getElementById('init-msg').textContent = '请填写完整信息。';
        return;
      }
      const parts = repoFull.split('/');
      if (parts.length !== 2) {
        document.getElementById('init-msg').textContent = '仓库名格式应为 "用户/仓库"。';
        return;
      }
      repoName = parts[1];
      document.getElementById('init-msg').textContent = '初始化中...';
      try {
        await loadImagesJSON();
        await loadInfoTXT();
        await loadHelpTXT();
        document.getElementById('album-section').style.display = 'block';
        document.getElementById('info-section').style.display = 'block';
        document.getElementById('help-section').style.display = 'block';
        document.getElementById('init-msg').textContent = '初始化完成。';
      } catch (err) {
        console.error(err);
        document.getElementById('init-msg').textContent = '初始化失败，请检查控制台与输入内容。';
      }
    });
    async function getFile(path) {
      const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
      const resp = await fetch(url, { headers: { Authorization: `token ${authToken}` } });
      if (!resp.ok) throw new Error(`获取 ${path} 失败：${resp.status}`);
      return resp.json();
    }
    async function putFile(path, contentBase64, sha, message) {
      const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
      const body = { message, content: contentBase64, sha };
      const resp = await fetch(url, {
        method: 'PUT',
        headers: { Authorization: `token ${authToken}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!resp.ok) throw new Error(`更新 ${path} 失败：${resp.status}`);
      return resp.json();
    }
    let imagesSHA;
    async function loadImagesJSON() {
      const data = await getFile('data/images.json');
      const images = JSON.parse(atob(data.content));
      imagesSHA = data.sha;
      renderAlbumList(images);
    }
    function renderAlbumList(images) {
      const container = document.getElementById('album-list');
      container.innerHTML = '';
      images.forEach(src => {
        const filename = src.split('/').pop();
        const nameNoExt = filename.replace(/\.[^/.]+$/, '');
        const div = document.createElement('div');
        div.className = 'album-item';
        div.innerHTML = `<img src="../${src}" alt="${nameNoExt}" /><span>${nameNoExt}</span><button class="delete-btn" onclick="deletePhoto('${src}')">×</button>`;
        container.appendChild(div);
      });
    }
    document.getElementById('btn-upload-photo').addEventListener('click', async () => {
      const fileInput = document.getElementById('album-upload');
      if (fileInput.files.length === 0) {
        document.getElementById('upload-msg').textContent = '请选择图片后再上传。';
        return;
      }
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const base64Data = reader.result.split(',')[1];
          const newPath = `image/${file.name}`;
          const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${newPath}`, {
            method: 'PUT',
            headers: { Authorization: `token ${authToken}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: `上传 ${file.name}`, content: base64Data })
          });
          if (!response.ok) throw new Error('上传失败');
          const data = await getFile('data/images.json');
          const images = JSON.parse(atob(data.content));
          images.push(newPath);
          imagesSHA = data.sha;
          const updatedContent = btoa(JSON.stringify(images, null, 2));
          await putFile('data/images.json', updatedContent, imagesSHA, `更新 images.json 添加 ${file.name}`);
          renderAlbumList(images);
          document.getElementById('upload-msg').textContent = `成功上传 ${file.name}`;
        } catch (err) {
          console.error(err);
          document.getElementById('upload-msg').textContent = '上传发生错误，请检查控制台。';
        }
      };
      reader.readAsDataURL(file);
    });
    async function deletePhoto(src) {
      if (!confirm(`确定删除 ${src.split('/').pop()}？`)) return;
      try {
        const data = await getFile(src);
        const delResp = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${src}`, {
          method: 'DELETE',
          headers: { Authorization: `token ${authToken}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: `删除 ${src}`, sha: data.sha })
        });
        if (!delResp.ok) throw new Error('删除失败');
        const imgData = await getFile('data/images.json');
        let images = JSON.parse(atob(imgData.content));
        images = images.filter(item => item !== src);
        imagesSHA = imgData.sha;
        const updatedContent = btoa(JSON.stringify(images, null, 2));
        await putFile('data/images.json', updatedContent, imagesSHA, `更新 images.json 删除 ${src}`);
        renderAlbumList(images);
        document.getElementById('upload-msg').textContent = `已删除 ${src.split('/').pop()}`;
      } catch (err) {
        console.error(err);
        document.getElementById('upload-msg').textContent = '删除发生错误，请检查控制台。';
      }
    }
    let infoSHA;
    async function loadInfoTXT() {
      const data = await getFile('data/info.txt');
      const content = atob(data.content);
      infoSHA = data.sha;
      document.getElementById('info-textarea').value = content;
    }
    document.getElementById('btn-save-info').addEventListener('click', async () => {
      const newText = document.getElementById('info-textarea').value;
      try {
        const updatedContent = btoa(newText);
        await putFile('data/info.txt', updatedContent, infoSHA, '更新 info.txt');
        document.getElementById('save-info-msg').textContent = '保存成功';
      } catch (err) {
        console.error(err);
        document.getElementById('save-info-msg').textContent = '保存失败，请检查控制台。';
      }
    });
    let helpSHA;
    async function loadHelpTXT() {
      const data = await getFile('data/help.txt');
      const content = atob(data.content).trim();
      helpSHA = data.sha;
      document.getElementById('help-input').value = content;
    }
    document.getElementById('btn-save-help').addEventListener('click', async () => {
      const newLink = document.getElementById('help-input').value.trim();
      try {
        const updatedContent = btoa(newLink);
        await putFile('data/help.txt', updatedContent, helpSHA, '更新 help.txt');
        document.getElementById('save-help-msg').textContent = '保存成功';
      } catch (err) {
        console.error(err);
        document.getElementById('save-help-msg').textContent = '保存失败，请检查控制台。';
      }
    });
  </script>
</body>
</html>
